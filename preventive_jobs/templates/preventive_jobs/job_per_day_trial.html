{% extends 'base.html' %}
{% load static %}

{% block title %}Job Per Hari - TRIAL (Daily + Project + Preventive){% endblock %}

{% block content %}
<style>
    /* Kompact export section */
    .export-section {
        position: sticky;
        bottom: 0;
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-top: 1px solid #dee2e6;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        margin-top: 10px;
        z-index: 999;
    }
    
    .export-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .export-buttons .btn {
        padding: 6px 14px;
        font-size: 13px;
        border-radius: 4px;
        white-space: nowrap;
    }
    
    .export-buttons .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .export-buttons .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 5px;
        font-size: 12px;
    }
    
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #ff9800;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 5px;
        vertical-align: middle;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Compact table & notification */
    .table-responsive {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
    }
    
    thead {
        position: sticky;
        top: 0;
        background-color: #343a40;
        z-index: 10;
    }
    
    tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    tbody tr.selected {
        background-color: #fff3e0;
    }
    
    #export-message {
        position: fixed;
        top: 100px;
        right: 20px;
        max-width: 350px;
        z-index: 1050;
        animation: slideInRight 0.3s ease-out;
    }
    
    #export-message .alert {
        margin: 0;
        padding: 10px 15px;
        border-radius: 4px;
        font-size: 13px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    #export-message .alert small {
        display: block;
        margin-top: 5px;
        opacity: 0.8;
    }
    
    #export-message .btn-sm {
        padding: 4px 10px;
        font-size: 12px;
        margin-top: 8px;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .trial-badge {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #ff9800;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: bold;
        z-index: 1000;
    }
    
    .progress-bar-custom {
        transition: width 0.6s ease;
    }
</style>

<!-- Trial Badge -->
<div class="trial-badge">ðŸ§ª HALAMAN TRIAL</div>

<!-- ============================================ -->
<!-- HEADER -->
<!-- ============================================ -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4>ðŸ“… Job Per Hari - Preventive (TRIAL)</h4>
        <p class="text-muted">Eksperimen menampilkan Preventive Jobs dalam format tabel Job Per Hari</p>
        <small class="text-warning"><strong>Note:</strong> Halaman ini adalah trial/eksperimen. Masih terpisah dari /job-per-day/ yang asli.</small>
    </div>
</div>

<!-- ============================================ -->
<!-- FILTER SECTION -->
<!-- ============================================ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label for="date-picker" class="form-label">Tanggal</label>
                <input type="date" id="date-picker" class="form-control" value="{{ selected_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-2">
                <label for="line-filter" class="form-label">Line</label>
                <select id="line-filter" class="form-select" onchange="filterTable()">
                    <option value="">Semua Line</option>
                    {% for line in all_lines %}
                    <option value="{{ line }}">{{ line }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="mesin-filter" class="form-label">Mesin</label>
                <select id="mesin-filter" class="form-select" onchange="filterTable()">
                    <option value="">Semua Mesin</option>
                    {% for mesin in all_mesins %}
                    <option value="{{ mesin }}">{{ mesin }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="submesin-filter" class="form-label">Sub Mesin</label>
                <select id="submesin-filter" class="form-select" onchange="filterTable()">
                    <option value="">Semua Sub Mesin</option>
                    {% for submesin in all_submesins %}
                    <option value="{{ submesin }}">{{ submesin }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="progress-filter" class="form-label">Progress</label>
                <select id="progress-filter" class="form-select" onchange="filterTable()">
                    <option value="">Semua Progress</option>
                    <option value="0">0% (Scheduled)</option>
                    <option value="100">100% (Done)</option>
                </select>
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary w-100" onclick="filterByDate()">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
            <div class="col-md-2 text-end">
                <span class="badge bg-secondary">{{ total_jobs }} job</span>
                <span class="badge bg-info" id="selected-count">0 dipilih</span>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- UNIFIED JOBS TABLE (Daily + Project + Preventive) -->
<!-- ============================================ -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0" id="jobs-table">
            <thead class="table-dark">
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="select-all" class="form-check-input" onchange="toggleSelectAll()">
                    </th>
                    <th>Tipe</th>
                    <th>Nama Pekerjaan</th>
                    <th>Template</th>
                    <th>Line</th>
                    <th>Mesin</th>
                    <th>Sub Mesin</th>
                    <th>PIC</th>
                    <th>Assigned To</th>
                    <th>Personil</th>
                    <th>Prioritas</th>
                    <th>Fokus</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Catatan</th>
                </tr>
            </thead>
            <tbody>
                {% for job in all_jobs %}
                <tr class="job-row" 
                    data-job-id="{{ job.id }}" 
                    data-job-type="{{ job.type }}"
                    data-line="{{ job.line }}"
                    data-mesin="{{ job.mesin }}"
                    data-submesin="{{ job.submesin }}"
                    data-progress="{{ job.progress }}">
                    <td>
                        <input type="checkbox" class="form-check-input job-checkbox" data-job-id="{{ job.id }}_{{ job.type }}" onchange="updateSelectedCount()">
                    </td>
                    <td>
                        {% if job.type == 'daily' %}
                        <span class="badge bg-info">Daily</span>
                        {% elif job.type == 'project' %}
                        <span class="badge bg-success">Project</span>
                        {% else %}
                        <span class="badge bg-danger">Preventive</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ job.nama }}</strong></td>
                    <td><small>{{ job.template_nama }}</small></td>
                    <td>{{ job.line }}</td>
                    <td>{{ job.mesin }}</td>
                    <td>{{ job.submesin }}</td>
                    <td>{{ job.pic }}</td>
                    <td>{{ job.assigned_to }}</td>
                    <td>
                        {% for personil in job.personil %}
                        <span class="badge bg-primary">{{ personil.nama_lengkap }}</span>
                        {% empty %}
                        <span class="text-muted">-</span>
                        {% endfor %}
                    </td>
                    <td>{{ job.prioritas }}</td>
                    <td>{{ job.fokus }}</td>
                    <td>
                        {% if job.status == 'Done' or job.status == 'Selesai' %}
                        <span class="badge bg-success">âœ“ Done</span>
                        {% elif job.status == 'Scheduled' %}
                        <span class="badge bg-info">Scheduled</span>
                        {% elif job.status == 'Proses' %}
                        <span class="badge bg-warning text-dark">Progress</span>
                        {% elif job.status == 'Skipped' %}
                        <span class="badge bg-warning text-dark">Skipped</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ job.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if job.progress == 100 %}
                        <span class="badge bg-success">100%</span>
                        {% elif job.progress >= 50 %}
                        <span class="badge bg-info">{{ job.progress }}%</span>
                        {% elif job.progress > 0 %}
                        <span class="badge bg-warning">{{ job.progress }}%</span>
                        {% else %}
                        <span class="badge bg-secondary">0%</span>
                        {% endif %}
                    </td>
                    <td><small>{{ job.catatan|truncatewords:5 }}</small></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="15" class="text-center text-muted py-4">
                        Tidak ada job untuk tanggal {{ selected_date|date:'d M Y' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================================ -->
<!-- EXPORT SECTION (STICKY BOTTOM - COMPACT) -->
<!-- ============================================ -->
<div class="export-section">
    <div class="export-buttons">
        <span class="badge bg-secondary" id="selected-count-bottom">0 dipilih</span>
        <button class="btn btn-success" onclick="exportJobs('preventif')" id="btn-preventif">
            <i class="bi bi-download"></i> Preventif
        </button>
        <button class="btn btn-warning text-dark" onclick="exportJobs('evaluasi')" id="btn-evaluasi">
            <i class="bi bi-download"></i> Evaluasi
        </button>
        <span class="loading" id="loading">
            <div class="spinner"></div>
            <span>Proses...</span>
        </span>
    </div>
</div>

<!-- Notification Area (Top Right) -->
<div id="export-message"></div>

<script>
// Ambil selected date dari input
function filterByDate() {
    const date = document.getElementById('date-picker').value;
    window.location.href = `?date=${date}`;
}

// Filter tabel berdasarkan dropdown filters
function filterTable() {
    const lineFilter = document.getElementById('line-filter').value.toLowerCase();
    const mesinFilter = document.getElementById('mesin-filter').value.toLowerCase();
    const submesinFilter = document.getElementById('submesin-filter').value.toLowerCase();
    const progressFilter = document.getElementById('progress-filter').value;
    
    document.querySelectorAll('.job-row').forEach(row => {
        const line = row.dataset.line.toLowerCase();
        const mesin = row.dataset.mesin.toLowerCase();
        const submesin = row.dataset.submesin.toLowerCase();
        const progress = parseInt(row.dataset.progress);
        
        const lineMatch = !lineFilter || line.includes(lineFilter);
        const mesinMatch = !mesinFilter || mesin.includes(mesinFilter);
        const submesinMatch = !submesinFilter || submesin.includes(submesinFilter);
        
        // Progress filter logic (0 = Scheduled, 100 = Done)
        let progressMatch = true;
        if (progressFilter) {
            progressMatch = progress === parseInt(progressFilter);
        }
        
        row.style.display = (lineMatch && mesinMatch && submesinMatch && progressMatch) ? '' : 'none';
    });
    
    updateSelectedCount();
}

// Update selected count (di header dan bottom bar)
function updateSelectedCount() {
    const checkedCount = document.querySelectorAll('.job-checkbox:checked').length;
    document.getElementById('selected-count').textContent = `${checkedCount} dipilih`;
    document.getElementById('selected-count-bottom').textContent = `${checkedCount} dipilih`;
}

// Select all checkbox
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all').checked;
    document.querySelectorAll('.job-checkbox').forEach(checkbox => {
        // Hanya checkbox yang tidak di-hide
        if (checkbox.closest('.job-row').style.display !== 'none') {
            checkbox.checked = selectAll;
        }
    });
    updateSelectedCount();
}

// Track selected jobs
function getSelectedJobIds() {
    const checkboxes = document.querySelectorAll('.job-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.dataset.jobId);
}

// Update row styling saat checkbox berubah
document.querySelectorAll('.job-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const row = this.closest('.job-row');
        if (this.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
        updateSelectedCount();
    });
});

// Show notification (auto-dismiss after 5 seconds)
function showNotification(message, type = 'success') {
    const messageDiv = document.getElementById('export-message');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';
    
    messageDiv.innerHTML = `
        <div class="alert ${alertClass}">
            <button type="button" class="btn-close" onclick="this.parentElement.style.display='none';"></button>
            <i class="bi ${icon}"></i> ${message}
        </div>
    `;
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        if (messageDiv.firstChild) {
            messageDiv.firstChild.style.display = 'none';
        }
    }, 5000);
}

// Export jobs ke Google Apps Script
function exportJobs(exportType) {
    const selectedJobIds = getSelectedJobIds();
    
    if (selectedJobIds.length === 0) {
        showNotification('âŒ Pilih minimal 1 job untuk di-export', 'error');
        return;
    }
    
    // Disable buttons & show loading
    document.getElementById('btn-preventif').disabled = true;
    document.getElementById('btn-evaluasi').disabled = true;
    document.getElementById('loading').style.display = 'inline-flex';
    document.getElementById('export-message').innerHTML = '';
    
    // Send request ke backend
    const payload = {
        job_ids: selectedJobIds,
        export_type: exportType
    };
    
    fetch('{% url "preventive_jobs:export_unified_jobs_to_gas" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response from backend:', data);
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.status === 'success') {
            // Show success notification
            const pdfUrl = data.data && data.data.pdfDownloadUrl ? data.data.pdfDownloadUrl : null;
            let message = `âœ… Export berhasil! (${selectedJobIds.length} jobs)`;
            if (pdfUrl) {
                message += ` - <a href="${pdfUrl}" class="alert-link" target="_blank">Download PDF</a>`;
            }
            showNotification(message, 'success');
        } else {
            // Show error notification
            showNotification(`âŒ Export gagal! ${data.message || 'Terjadi kesalahan'}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').style.display = 'none';
        showNotification(`âŒ Koneksi error! ${error.message}`, 'error');
    })
    .finally(() => {
        // Re-enable buttons
        document.getElementById('btn-preventif').disabled = false;
        document.getElementById('btn-evaluasi').disabled = false;
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.job-checkbox').forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.closest('.job-row').classList.add('selected');
        }
    });
    updateSelectedCount();
});
</script>

{% endblock %}
