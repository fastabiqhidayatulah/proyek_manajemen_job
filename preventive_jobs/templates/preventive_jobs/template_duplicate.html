{% extends 'base.html' %}
{% load static %}

{% block title %}Duplicate Template - Preventive Job V2{% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- PAGE HEADER -->
            <div class="mb-4">
                {% if next %}
                    <a href="{{ next }}" class="btn btn-secondary btn-sm mb-3">
                        <i class="bi bi-arrow-left"></i> Kembali
                    </a>
                {% else %}
                    <a href="{% url 'preventive_jobs:template_detail' original.id %}" class="btn btn-secondary btn-sm mb-3">
                        <i class="bi bi-arrow-left"></i> Kembali
                    </a>
                {% endif %}
                <h2>üìã Duplicate Template</h2>
                <p class="text-muted">Buat template untuk periode/jadwal berbeda dengan config yang sama</p>
            </div>

            <!-- ORIGINAL TEMPLATE INFO -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìå Template Original</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nama Pekerjaan:</strong></p>
                            <p class="text-primary">{{ original.nama_pekerjaan }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Periode Original:</strong></p>
                            <p>
                                <span class="badge bg-secondary">
                                    {{ original.tanggal_mulai|date:"d M Y" }} - 
                                    {% if original.tanggal_berakhir %}
                                        {{ original.tanggal_berakhir|date:"d M Y" }}
                                    {% else %}
                                        Ongoing
                                    {% endif %}
                                </span>
                            </p>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Jadwal Type:</strong></p>
                            <p>
                                {% if original.schedule_type == 'interval' %}
                                    <span class="badge bg-success">Interval-Based (Setiap {{ original.interval_hari }} hari)</span>
                                {% else %}
                                    <span class="badge bg-success">Custom Dates</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Mesin/Aset:</strong></p>
                            <div>
                                {% for aset in original.aset_mesin.all %}
                                    <span class="badge bg-primary me-1">{{ aset.nama }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Fokus:</strong> {{ original.get_fokus_display }}</p>
                            <p><strong>Kategori:</strong> {{ original.get_kategori_display }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Prioritas:</strong> 
                                <span class="badge {% if original.prioritas == 'P1' %}bg-danger{% elif original.prioritas == 'P2' %}bg-warning{% elif original.prioritas == 'P3' %}bg-info{% else %}bg-success{% endif %}">
                                    {{ original.get_prioritas_display }}
                                </span>
                            </p>
                            <p><strong>PIC:</strong> {{ original.pic.get_full_name|default:original.pic.username }}</p>
                        </div>
                    </div>

                    {% if original.checklist_template %}
                        <hr>
                        <p><strong>Checklist Template:</strong> <span class="badge bg-warning">{{ original.checklist_template.nama }}</span></p>
                    {% endif %}
                </div>
            </div>

            <!-- DUPLICATE FORM -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚ú® Input Periode Baru</h5>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Hidden field untuk next parameter -->
                        {% if next %}
                            <input type="hidden" name="next" value="{{ next }}">
                        {% endif %}

                        <!-- INFO BOX -->
                        <div class="alert alert-info mb-4" role="alert">
                            <h6 class="alert-heading">üí° Cara Kerja:</h6>
                            <ul class="mb-0 small">
                                <li>Masukkan tanggal mulai dan berakhir untuk periode baru</li>
                                <li>Semua konfigurasi template (nama, jadwal, aset, checklist, dll) akan di-copy otomatis</li>
                                <li>Sistem akan auto-generate execution records untuk periode baru</li>
                                <li>Template original tetap intact (tidak berubah)</li>
                            </ul>
                        </div>

                        <!-- FORM FIELDS -->
                        <div class="form-group mb-3">
                            <label for="{{ form.tanggal_mulai.id_for_label }}" class="form-label">
                                {{ form.tanggal_mulai.label }}
                            </label>
                            {% if suggested_start %}
                                <small class="text-muted d-block mb-2">
                                    üí° Saran: {{ suggested_start|date:"d M Y" }} (hari setelah template original berakhir)
                                </small>
                            {% endif %}
                            {{ form.tanggal_mulai }}
                            {% if form.tanggal_mulai.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tanggal_mulai.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.tanggal_mulai.help_text|safe }}</small>
                        </div>

                        <div class="form-group mb-4">
                            <label for="{{ form.tanggal_berakhir.id_for_label }}" class="form-label">
                                {{ form.tanggal_berakhir.label }}
                            </label>
                            {% if suggested_end %}
                                <small class="text-muted d-block mb-2">
                                    üí° Saran: {{ suggested_end|date:"d M Y" }} (1 bulan dari tanggal mulai)
                                </small>
                            {% endif %}
                            {{ form.tanggal_berakhir }}
                            {% if form.tanggal_berakhir.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tanggal_berakhir.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.tanggal_berakhir.help_text|safe }}</small>
                        </div>

                        <!-- ERROR MESSAGE -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger" role="alert">
                                {% for error in form.non_field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- BUTTONS -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg flex-grow-1">
                                <i class="bi bi-check-circle"></i> Duplicate & Generate Executions
                            </button>
                            {% if next %}
                                <a href="{{ next }}" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> Batal
                                </a>
                            {% else %}
                                <a href="{% url 'preventive_jobs:template_detail' original.id %}" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> Batal
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- INFO SECTION -->
            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h6 class="card-title">‚ùì FAQ</h6>
                    
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqOne">
                                    Apa bedanya dengan edit template?
                                </button>
                            </h2>
                            <div id="faqOne" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <p><strong>Edit Template:</strong> Mengubah template existing (historical data tercampur)</p>
                                    <p><strong>Duplicate Template:</strong> Membuat template baru dengan periode/jadwal berbeda (data isolated, clean audit trail)</p>
                                    <p class="text-success"><strong>‚úÖ Rekomendasi:</strong> Gunakan Duplicate untuk setiap periode baru, jangan edit existing template</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqTwo">
                                    Berapa banyak execution yang akan di-generate?
                                </button>
                            </h2>
                            <div id="faqTwo" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <p>Jumlah execution tergantung:</p>
                                    <ul>
                                        <li><strong>Interval-based:</strong> (tanggal_berakhir - tanggal_mulai) / interval_hari √ó jumlah_aset</li>
                                        <li><strong>Custom dates:</strong> Jumlah custom dates √ó jumlah_aset</li>
                                    </ul>
                                    <p class="text-info">üí° Contoh: 30 hari, interval 1 hari, 2 aset = 60 executions</p>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqThree">
                                    Apa yang di-copy dari template original?
                                </button>
                            </h2>
                            <div id="faqThree" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <p><strong>Dicopy:</strong></p>
                                    <ul>
                                        <li>Nama pekerjaan, deskripsi</li>
                                        <li>Jadwal type & interval (schedule_type, interval_hari, custom_dates)</li>
                                        <li>Mesin/aset (aset_mesin)</li>
                                        <li>Fokus, kategori, prioritas</li>
                                        <li>PIC & notification preferences</li>
                                        <li>Checklist template</li>
                                    </ul>
                                    <p><strong>Tidak dicopy / Hanya input user:</strong></p>
                                    <ul>
                                        <li>Tanggal mulai & tanggal berakhir (periode baru)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqFour">
                                    Bisakah saya ubah interval saat duplicate?
                                </button>
                            </h2>
                            <div id="faqFour" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    <p><strong>Jawab:</strong> Tidak (untuk menjaga simplicity). Interval akan dicopy sama dengan original.</p>
                                    <p>Jika perlu ubah interval, Anda bisa:</p>
                                    <ol>
                                        <li>Duplicate template (untuk periode/tanggal baru)</li>
                                        <li>Edit template yang sudah di-duplicate ‚Üí ubah interval_hari</li>
                                        <li>Execution baru akan di-generate dengan interval yang baru</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Form validation
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
</script>

{% endblock %}
