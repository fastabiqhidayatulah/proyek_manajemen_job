{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
  <h3>Isi Checklist</h3>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% else %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Pekerjaan: {{ execution.template.nama_pekerjaan }}</h5>
        <p class="card-text">Tanggal terjadwal: {{ execution.scheduled_date }}</p>
      </div>
    </div>

    <form id="checklist-form">
      <input type="hidden" id="token" name="token" value="{{ token }}" />

      <div id="items-container" class="mb-3">
        {% for item in items %}
          <div class="mb-2 border p-2" data-item-id="{{ item.id }}">
            <div class="d-flex justify-content-between">
              <div>
                <strong>{{ forloop.counter }}. {{ item.item_pemeriksaan }}</strong>
                <div class="text-muted">Standar: {{ item.standar_normal }} {{ item.satuan }}</div>
              </div>
              <div style="min-width:240px">
                <div class="mb-1">
                  <label class="form-label mb-0">Nilai</label>
                  <input type="text" class="form-control form-control-sm item-nilai" />
                </div>
                <div>
                  <label class="form-label mb-0">Status</label>
                  <select class="form-select form-select-sm item-status">
                    <option value="OK">OK</option>
                    <option value="NG">NG</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mb-3">
        <label class="form-label">Catatan umum</label>
        <textarea id="catatan_umum" class="form-control" rows="3">{{ existing_result.catatan_umum|default_if_none:"" }}</textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Nama (opsional)</label>
        <input id="submit_nama" class="form-control" />
      </div>
      <div class="mb-3">
        <label class="form-label">Nomor telepon (opsional)</label>
        <input id="submit_nomor" class="form-control" />
      </div>

      <button type="button" id="submit-btn" class="btn btn-primary">Kirim</button>
    </form>

    <div id="result-message" class="mt-3"></div>
  {% endif %}
</div>

<script>
(function(){
  const submitBtn = document.getElementById('submit-btn');
  const token = document.getElementById('token') ? document.getElementById('token').value : '';
  submitBtn && submitBtn.addEventListener('click', function(){
    const itemsContainer = document.getElementById('items-container');
    const itemNodes = itemsContainer.querySelectorAll('[data-item-id]');
    const hasil_pengukuran = {};
    const status_item = {};

    itemNodes.forEach(function(node){
      const itemId = node.getAttribute('data-item-id');
      const nilaiEl = node.querySelector('.item-nilai');
      const statusEl = node.querySelector('.item-status');
      const nilai = nilaiEl ? nilaiEl.value : '';
      const status = statusEl ? statusEl.value : 'OK';
      jikaNilai = nilai;
      // Keep structure consistent with server expectations
      hasil_pengukuran[itemId] = { nilai: nilai };
      status_item[itemId] = status;
    });

    const payload = {
      token: token,
      hasil_pengukuran: hasil_pengukuran,
      status_item: status_item,
      catatan_umum: document.getElementById('catatan_umum').value || '',
      nama: document.getElementById('submit_nama').value || '',
      nomor: document.getElementById('submit_nomor').value || ''
    };

    fetch('{% url "preventive_jobs:save_checklist_via_token" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    }).then(r=>r.json()).then(data=>{
      const el = document.getElementById('result-message');
      if(data.success){
        el.innerHTML = '<div class="alert alert-success">'+(data.message || 'Berhasil disimpan.')+'</div>';
        submitBtn.disabled = true;
      }else{
        el.innerHTML = '<div class="alert alert-danger">'+(data.message || 'Terjadi kesalahan')+'</div>';
      }
    }).catch(err=>{
      const el = document.getElementById('result-message');
      el.innerHTML = '<div class="alert alert-danger">Permintaan gagal: '+err+'</div>';
    });
  });
})();
</script>

{% endblock %}
