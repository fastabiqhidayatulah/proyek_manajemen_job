{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        Edit Meeting
    {% else %}
        Buat Meeting Baru
    {% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <!-- Header -->
            <div class="mb-4">
                <h2>
                    {% if form.instance.pk %}
                        <i class="bi bi-pencil-square"></i> Edit Meeting
                    {% else %}
                        <i class="bi bi-plus-circle"></i> Buat Meeting Baru
                    {% endif %}
                </h2>
                <p class="text-muted">
                    {% if form.instance.pk %}
                        Update detail meeting
                    {% else %}
                        Buat meeting/notulen rapat baru
                    {% endif %}
                </p>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Meeting Details Section -->
                        <fieldset class="mb-4">
                            <legend class="fs-6 fw-bold mb-3">
                                <i class="bi bi-info-circle"></i> Detail Meeting
                            </legend>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.tanggal_meeting.id_for_label }}" class="form-label">
                                            Tanggal Meeting <span class="text-danger">*</span>
                                        </label>
                                        {{ form.tanggal_meeting }}
                                        {% if form.tanggal_meeting.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.tanggal_meeting.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="{{ form.jam_mulai.id_for_label }}" class="form-label">
                                            Jam Mulai <span class="text-danger">*</span>
                                        </label>
                                        {{ form.jam_mulai }}
                                        {% if form.jam_mulai.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.jam_mulai.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="{{ form.jam_selesai.id_for_label }}" class="form-label">
                                            Jam Selesai <span class="text-danger">*</span>
                                        </label>
                                        {{ form.jam_selesai }}
                                        {% if form.jam_selesai.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.jam_selesai.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.tempat.id_for_label }}" class="form-label">
                                    Lokasi/Tempat <span class="text-danger">*</span>
                                </label>
                                {{ form.tempat }}
                                {% if form.tempat.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.tempat.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.agenda.id_for_label }}" class="form-label">
                                    Agenda <span class="text-danger">*</span>
                                </label>
                                {{ form.agenda }}
                                {% if form.agenda.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.agenda.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </fieldset>

                        <!-- Peserta Section -->
                        <fieldset class="mb-4">
                            <legend class="fs-6 fw-bold mb-3">
                                <i class="bi bi-people-fill"></i> Peserta Internal
                            </legend>
                            
                            <!-- Display Selected Count -->
                            <div class="mb-3">
                                <small class="text-muted">Pilih peserta yang mengikuti meeting</small>
                                <div id="pesertaDisplay" class="mt-2">
                                    <p class="text-muted"><em>Belum ada peserta dipilih</em></p>
                                </div>
                            </div>

                            <!-- Button to Open Modal -->
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#pesertaModal">
                                <i class="bi bi-plus-circle"></i> Pilih Peserta
                            </button>

                            <!-- Hidden input untuk simpan selected peserta IDs -->
                            {{ form.peserta }}
                            {% if form.peserta.errors %}
                                <div class="invalid-feedback d-block mt-2">
                                    {{ form.peserta.errors.0 }}
                                </div>
                            {% endif %}
                        </fieldset>

                        <!-- Notes Section -->
                        <fieldset class="mb-4">
                            <legend class="fs-6 fw-bold mb-3">
                                <i class="bi bi-chat-left"></i> Catatan Tambahan
                            </legend>
                            {{ form.notes }}
                        </fieldset>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i>
                                {% if form.instance.pk %}
                                    Update Meeting
                                {% else %}
                                    Buat Meeting
                                {% endif %}
                            </button>
                            <a href="{% url 'meetings:meeting-list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Batal
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Text -->
            <div class="alert alert-info mt-4" role="alert">
                <i class="bi bi-lightbulb"></i>
                <strong>Tips:</strong> Setelah membuat meeting, Anda bisa menambahkan notulen items (action items) dan mengatur peserta.
            </div>
        </div>
    </div>
</div>

<!-- Modal Pilih Peserta -->
<div class="modal fade" id="pesertaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-people-fill"></i> Pilih Peserta Internal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <!-- Search Field -->
                <div class="mb-3">
                    <input type="text" id="pesertaSearch" class="form-control" placeholder="Cari nama peserta...">
                </div>

                <!-- Peserta Checkboxes -->
                <div id="pesertaList" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                    {% for peserta in peserta_list %}
                    <div class="form-check">
                        <input class="form-check-input peserta-checkbox" type="checkbox" 
                               id="peserta_{{ peserta.pk }}" value="{{ peserta.pk }}"
                               data-name="{{ peserta.get_full_name }}">
                        <label class="form-check-label" for="peserta_{{ peserta.pk }}">
                            <strong>{{ peserta.get_full_name }}</strong>
                            <br>
                            <small class="text-muted">@{{ peserta.username }}</small>
                        </label>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center my-3">Tidak ada peserta</p>
                    {% endfor %}
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="pesertaSaveBtn" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle"></i> Simpan Pilihan
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
    }
    
    /* Peserta checkbox styling */
    .form-check {
        padding-left: 1.5rem;
    }
    
    .form-check-input {
        margin-left: -1.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pesertaSelect = document.getElementById('id_peserta');
    const pesertaSearch = document.getElementById('pesertaSearch');
    const pesertaDisplay = document.getElementById('pesertaDisplay');
    const pesertaSaveBtn = document.getElementById('pesertaSaveBtn');
    const allCheckboxes = document.querySelectorAll('.peserta-checkbox');

    console.log('Init:', {
        pesertaSelect: !!pesertaSelect,
        pesertaSearch: !!pesertaSearch,
        pesertaDisplay: !!pesertaDisplay,
        pesertaSaveBtn: !!pesertaSaveBtn,
        checkboxCount: allCheckboxes.length
    });

    // Helper: Get all selected peserta IDs from select
    function getSelectedIds() {
        const ids = new Set();
        if (pesertaSelect && pesertaSelect.options) {
            Array.from(pesertaSelect.options).forEach(option => {
                if (option.selected && option.value) {
                    ids.add(option.value);
                }
            });
        }
        return ids;
    }

    // Update display
    function updateDisplay() {
        const selectedIds = getSelectedIds();
        
        if (selectedIds.size === 0) {
            pesertaDisplay.innerHTML = '<p class="text-muted"><em>Belum ada peserta dipilih</em></p>';
        } else {
            const names = [];
            
            selectedIds.forEach(id => {
                // Find dari select options (source of truth)
                const option = Array.from(pesertaSelect.options).find(opt => opt.value === id);
                if (option) {
                    names.push(option.text);
                }
            });
            
            pesertaDisplay.innerHTML = `
                <div class="d-flex flex-wrap gap-2">
                    ${names.map(name => `<span class="badge bg-primary">${name}</span>`).join('')}
                </div>
                <small class="text-muted d-block mt-2">Total: ${names.length} peserta dipilih</small>
            `;
        }
    }

    // Pre-check peserta yang sudah dipilih
    function syncCheckboxes() {
        const selectedIds = getSelectedIds();
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = selectedIds.has(checkbox.value);
        });
    }

    // Search filter with better logic
    pesertaSearch.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        let visibleCount = 0;
        
        allCheckboxes.forEach(checkbox => {
            const checkboxDiv = checkbox.parentElement;
            const label = checkboxDiv.querySelector('label').textContent.toLowerCase();
            const shouldShow = filter === '' || label.includes(filter);
            
            if (shouldShow) {
                checkboxDiv.style.display = 'block';
                visibleCount++;
            } else {
                checkboxDiv.style.display = 'none';
            }
        });

        // Show "not found" message if no results
        const pesertaList = document.getElementById('pesertaList');
        const notFound = pesertaList.querySelector('.text-muted.text-center');
        
        if (visibleCount === 0 && !notFound) {
            const msg = document.createElement('p');
            msg.className = 'text-muted text-center my-3';
            msg.textContent = 'Peserta tidak ditemukan';
            pesertaList.appendChild(msg);
        } else if (visibleCount > 0 && notFound) {
            notFound.remove();
        }
    });

    // Save selections
    pesertaSaveBtn.addEventListener('click', function() {
        const checked = document.querySelectorAll('.peserta-checkbox:checked');
        
        // Clear and update select with checked boxes
        pesertaSelect.innerHTML = '';
        
        checked.forEach(checkbox => {
            const option = document.createElement('option');
            option.value = checkbox.value;
            option.text = checkbox.getAttribute('data-name') || checkbox.value;
            option.selected = true;
            pesertaSelect.appendChild(option);
        });

        console.log('Saved', pesertaSelect.options.length, 'peserta'); // Debug
        updateDisplay();
    });

    // Modal events
    const pesertaModal = document.getElementById('pesertaModal');
    pesertaModal.addEventListener('show.bs.modal', function() {
        // Reset search
        pesertaSearch.value = '';
        
        // Re-sync checkboxes dari select
        syncCheckboxes();
        
        // Show all items
        allCheckboxes.forEach(checkbox => {
            checkbox.parentElement.style.display = 'block';
        });
        
        pesertaSearch.focus();
    });

    // Initial setup
    syncCheckboxes();
    updateDisplay();
});
</script>
{% endblock %}
